<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéì Qu·∫£n l√Ω l∆∞∆°ng vi√™n ch·ª©c ‚Äì Tr∆∞·ªùng Ti·ªÉu h·ªçc</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { 600:'#4f46e5', 700:'#4338ca' } }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet"/>

  <!-- XLSX: KH√îNG defer ƒë·ªÉ ƒë·∫£m b·∫£o t·∫£i xong tr∆∞·ªõc app script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    html,body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    .diff-cell{background:#fef3c7}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-gradient-to-r from-brand-600 to-indigo-600 text-white">
    <div class="max-w-7xl mx-auto px-4 lg:px-6 py-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">üéì Qu·∫£n l√Ω l∆∞∆°ng vi√™n ch·ª©c ‚Äì Tr∆∞·ªùng Ti·ªÉu h·ªçc</h1>
        <p class="text-white/90">Import Excel ‚Üí Verify kh√°c bi·ªát ‚Üí C·∫≠p nh·∫≠t t·ª´ng ph·∫ßn</p>
      </div>
      <div class="text-sm opacity-90">B·∫£n 1 file ‚Äúd√°n ƒë√®‚Äù</div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 lg:px-6 py-8 space-y-8">
    <!-- Import & Tools -->
    <section class="bg-white rounded-2xl shadow-sm ring-1 ring-slate-100 p-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
        <div>
          <h2 class="text-xl font-semibold">üìÇ Import Excel (c√≥ Verify)</h2>
          <p class="text-slate-500 text-sm">So s√°nh v·ªõi d·ªØ li·ªáu hi·ªán t·∫°i, highlight kh√°c bi·ªát v√† cho ph√©p ch·ªçn c·∫≠p nh·∫≠t.</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="excelFileInput" type="file" accept=".xlsx,.xls"
                 class="file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-brand-600 file:text-white file:font-semibold
                        file:hover:bg-brand-700 file:cursor-pointer
                        px-3 py-2 border rounded-lg w-64" />
          <button id="uploadExcelBtn" class="bg-brand-600 hover:bg-brand-700 text-white font-semibold px-4 py-2 rounded-lg">
            üì§ T·∫£i l√™n (Verify)
          </button>
          <button id="exportExcelBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">
            üì• Xu·∫•t Excel (ƒëang xem)
          </button>
        </div>
      </div>

      <!-- Search -->
      <div class="mt-5 grid md:grid-cols-2 gap-3">
        <input id="searchInput" class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-600"
               placeholder="üîé T√¨m theo h·ªç t√™n / ch·ª©c danh / ƒë∆°n v·ªã / h·∫°ng / m√£ CDNN..." />
        <div id="rankChips" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Filters -->
      <div class="mt-3 grid md:grid-cols-3 gap-3">
        <select id="filterRole" class="px-3 py-2 border rounded-lg">
          <option value="">‚Äî T·∫•t c·∫£ ch·ª©c danh ‚Äî</option>
        </select>
        <select id="filterLevel" class="px-3 py-2 border rounded-lg">
          <option value="">‚Äî T·∫•t c·∫£ c·∫•p h·ªçc ‚Äî</option>
        </select>
        <select id="filterRank" class="px-3 py-2 border rounded-lg">
          <option value="">‚Äî T·∫•t c·∫£ h·∫°ng ‚Äî</option>
        </select>
      </div>
    </section>

    <!-- KPIs -->
    <section class="bg-white rounded-2xl shadow-sm ring-1 ring-slate-100 p-6">
      <h3 class="text-lg font-semibold mb-4">üìä T·ªïng quan</h3>
      <div id="excelKpis" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
    </section>

    <!-- Table -->
    <section class="bg-white rounded-2xl shadow-sm ring-1 ring-slate-100 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">üìã B·∫£ng d·ªØ li·ªáu</h3>
        <div class="text-sm text-slate-500">B·∫•m ti√™u ƒë·ªÅ c·ªôt ƒë·ªÉ s·∫Øp x·∫øp</div>
      </div>
      <div id="tableRoot" class="overflow-auto rounded-lg border border-slate-200"></div>
    </section>
  </main>

  <!-- VERIFY MODAL -->
  <div id="verifyModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-5xl overflow-hidden">
      <div class="px-5 py-4 border-b flex items-center justify-between">
        <h4 class="font-semibold">üîé Ki·ªÉm tra d·ªØ li·ªáu tr∆∞·ªõc khi √°p d·ª•ng</h4>
        <button id="closeVerifyBtn" class="px-2 py-1 rounded hover:bg-slate-100">‚úñ</button>
      </div>
      <div class="p-5 space-y-4">
        <div id="verifySummary" class="text-sm"></div>
        <div id="verifyBody" class="space-y-4"></div>
      </div>
      <div class="px-5 py-4 border-t flex items-center justify-end gap-2">
        <button id="cancelImportBtn" class="px-4 py-2 rounded border hover:bg-slate-50">H·ªßy</button>
        <button id="confirmImportBtn" class="px-4 py-2 rounded bg-brand-600 hover:bg-brand-700 text-white">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- APP -->
  <script>
  (function(){
    // ===== Utils =====
    const $ = (id)=>document.getElementById(id);
    const on = (el, ev, fn)=>el && el.addEventListener(ev, fn);
    const slug = s => String(s ?? "")
      .toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/\s+/g," ").trim();

    function parseNumber(x){
      if (x==null || x==="") return null;
      const n = Number(String(x).replace(",", "."));
      return Number.isFinite(n) ? n : null;
    }
    function parseDate(v){
      if (!v) return null;
      if (typeof v === "number"){ const epoch = new Date(Date.UTC(1899,11,30)); return new Date(epoch.getTime() + v*86400000); }
      const s = String(v).trim();
      const iso = Date.parse(s);
      if (!Number.isNaN(iso)) return new Date(iso);
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (m) return new Date(+m[3], +m[2]-1, +m[1]);
      return null;
    }
    function unifyRole(raw){
      const t = slug(raw);
      if (!t) return "";
      if (t.includes("pho hieu truong")) return "Ph√≥ Hi·ªáu tr∆∞·ªüng";
      if (t.includes("hieu truong"))     return "Hi·ªáu tr∆∞·ªüng";
      if (t.includes("tpt") || t.includes("tong phu trach")) return "TPT ƒê·ªôi";
      if (t.includes("giao vien"))       return "Gi√°o vi√™n";
      return raw || "";
    }
    function splitCdnnHang(val){
      const s = String(val ?? "").replace(/‚Äì/g,"-");
      const [p1, p2] = s.split("-").map(x=>String(x||"").trim());
      let level = p1 || "", rankCode = "", possibleDate = null;
      if (p2){
        if (/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(p2)) possibleDate = parseDate(p2);
        else if (/^\d{3,}$/.test(p2)) rankCode = p2;
      }
      return { level, rankCode, possibleDate };
    }

    // ===== Parser Excel ‚Üí rows (tolerant++) =====
    async function parseExcelFile(file){
      if (typeof XLSX === "undefined") throw new Error("Thi·∫øu th∆∞ vi·ªán XLSX.");
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type:"array" });

      const nrm = (s)=> String(s ?? "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9\s\/\-&]/g,"")
        .replace(/\s+/g," ").trim();

      const SYN = {
        NAME: [
          "ho va ten","ho ten","ho & ten","hovaten",
          "ho va ten vien chuc","ho va ten giao vien","ho ten gv","ho ten vien chuc",
          "ho ten (viet hoa)","ho ten (ghi chu in hoa)","ten giao vien","ten gv","ho va ten cbvc","ho va ten can bo"
        ],
        ROLE: ["chuc danh","chuc vu","chuc danh nghe nghiep","chuc danh nn"],
        UNIT: ["don vi","donvi","truong","bo mon","to","to chuyen mon"],
        CDNNHANG: ["cdnn/hang","cdnn","hang","cdnn - hang","cdnn hang"],
        MACDNN: ["ma cdnn","ma so cdnn","ma so","ma so nn"],
        HESO: ["he so","he so luong","he-so","he_so"],
        NGAYHUONG: ["ngay huong","ngay hieu luc","ngay bat dau","ngay ap dung"],
        CAPHOC: ["cap hoc","cap","bac hoc","trinh do day"],
        GHICHU: ["ghi chu","ghi chuÃÅ","note","ghi chu khac"]
      };

      const looksLikeName = (s)=>{
        s = String(s??"").trim();
        if (!s) return false;
        if (/\d/.test(s)) return false;
        const words = s.split(/\s+/);
        return words.length>=2 && s.length<=60;
      };

      function isMatch(cellNorm, synList){ return synList.some(syn => cellNorm.includes(syn)); }

      function guessNameCol(rows, fromRow, maxCols){
        let bestIdx = -1, bestScore = -1;
        for (let c=0;c<maxCols;c++){
          let score = 0, seen = 0;
          for (let r=fromRow;r<Math.min(rows.length, fromRow+40); r++){
            const v = rows[r]?.[c];
            if (looksLikeName(v)) score++;
            if (String(v??"").trim()) seen++;
          }
          const ratio = seen ? score/seen : 0;
          if (ratio > bestScore){ bestScore = ratio; bestIdx = c; }
        }
        return (bestScore >= 0.35) ? bestIdx : -1;
      }

      function parseSheet(ws){
        const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
        if (!rows.length) return [];

        // 1) T√¨m header chu·∫©n
        let headerRowIdx = -1, map = {};
        for (let i=0;i<Math.min(rows.length,100);i++){
          const row = rows[i] || [];
          const cells = row.map(nrm);
          const m = {};
          cells.forEach((cn, idx)=>{
            if (cn && m.NAME==null     && (isMatch(cn,SYN.NAME) || (cn.includes("ho") && cn.includes("ten")))) m.NAME = idx;
            if (cn && m.ROLE==null     && isMatch(cn,SYN.ROLE))     m.ROLE = idx;
            if (cn && m.UNIT==null     && isMatch(cn,SYN.UNIT))     m.UNIT = idx;
            if (cn && m.CDNNHANG==null && isMatch(cn,SYN.CDNNHANG)) m.CDNNHANG = idx;
            if (cn && m.MACDNN==null   && isMatch(cn,SYN.MACDNN))   m.MACDNN = idx;
            if (cn && m.HESO==null     && isMatch(cn,SYN.HESO))     m.HESO = idx;
            if (cn && m.NGAYHUONG==null&& isMatch(cn,SYN.NGAYHUONG))m.NGAYHUONG = idx;
            if (cn && m.CAPHOC==null   && isMatch(cn,SYN.CAPHOC))   m.CAPHOC = idx;
            if (cn && m.GHICHU==null   && isMatch(cn,SYN.GHICHU))   m.GHICHU = idx;
          });
          if (m.NAME != null){ headerRowIdx = i; map = m; break; }
        }

        // 2) Kh√¥ng c√≥ header ‚Üí ƒëo√°n c·ªôt t√™n & d√≤ d√≤ng d·ªØ li·ªáu
        if (headerRowIdx === -1){
          const maxCols = Math.max(...rows.slice(0,30).map(r=>r?.length||0), 0);
          const nameCol = guessNameCol(rows, 0, maxCols);
          if (nameCol < 0) return [];
          let start = 0;
          for (let i=0;i<Math.min(rows.length,120);i++){
            if (looksLikeName(rows[i]?.[nameCol])) { start = i; break; }
          }
          const out=[];
          for (let r=start; r<rows.length; r++){
            const row = rows[r] || [];
            const name = String(row[nameCol] ?? "").trim();
            if (!looksLikeName(name)) continue;

            let level="", rankCode="", possibleDate=null;
            for (let c=0;c<row.length;c++){
              if (c===nameCol) continue;
              const v = row[c];
              if (v==null) continue;
              const s = String(v);
              if (s.includes("-") || /cdnn|hang/i.test(s)){
                const x = splitCdnnHang(s);
                level = level || x.level;
                rankCode = rankCode || x.rankCode;
                possibleDate = possibleDate || x.possibleDate;
              }
            }

            out.push({
              name,
              role: "", unit: "",
              level, rank:"", rankCode,
              coefficient: null,
              effectiveDate: possibleDate,
              note: ""
            });
          }
          return out;
        }

        // 3) C√≥ header ‚Üí parse ƒë·∫ßy ƒë·ªß
        const out=[];
        for (let r=headerRowIdx+1; r<rows.length; r++){
          const row = rows[r] || [];
          const name = String(row[map.NAME] ?? "").trim();
          if (!name) continue;

          const rawRole   = map.ROLE!=null     ? row[map.ROLE]     : "";
          const unit      = map.UNIT!=null     ? row[map.UNIT]     : "";
          const cdnnHang  = map.CDNNHANG!=null ? row[map.CDNNHANG] : "";
          const maCdnn    = map.MACDNN!=null   ? row[map.MACDNN]   : "";
          const coef      = map.HESO!=null     ? parseNumber(row[map.HESO]) : null;
          const ngayHuong = map.NGAYHUONG!=null? row[map.NGAYHUONG]: "";
          const levelCol  = map.CAPHOC!=null   ? row[map.CAPHOC]   : "";
          const note      = map.GHICHU!=null   ? row[map.GHICHU]   : "";

          let { level, rankCode, possibleDate } = splitCdnnHang(cdnnHang);
          if (!level && levelCol) level = String(levelCol);
          if (!rankCode && maCdnn) rankCode = String(maCdnn);
          const effectiveDate = parseDate(ngayHuong) || possibleDate || null;

          out.push({
            name,
            role: unifyRole(rawRole),
            unit: unit || "",
            level: level || "",
            rank: "",
            rankCode: rankCode || "",
            coefficient: coef,
            effectiveDate,
            note: note || ""
          });
        }
        return out;
      }

      // duy·ªát t·∫•t c·∫£ sheet
      for (const sn of wb.SheetNames){
        const ws = wb.Sheets[sn];
        const parsed = parseSheet(ws);
        if (parsed.length) return parsed;
      }
      return [];
    }

    // ===== Diff & Verify =====
    const FIELDS = [
      ["role","Ch·ª©c danh"], ["unit","ƒê∆°n v·ªã"], ["level","C·∫•p h·ªçc"],
      ["rank","H·∫°ng"], ["rankCode","M√£ CDNN"], ["coefficient","H·ªá s·ªë"],
      ["effectiveDate","Ng√†y h∆∞·ªüng"], ["note","Ghi ch√∫"]
    ];
    const rowKey = r => `${slug(r?.name)}|${slug(r?.unit)}`;
    const normVal = v => v instanceof Date ? v.toISOString().slice(0,10)
                         : (typeof v==="number" ? (Number.isFinite(v)?v:"") : (v==null?"":String(v).trim()));

    function diffDatasets(curRows, incRows){
      const curMap = new Map(curRows.map(r=>[rowKey(r), r]));
      const incMap = new Map(incRows.map(r=>[rowKey(r), r]));
      const added=[], removed=[], updated=[];

      for (const [k, inc] of incMap.entries()){
        const cur = curMap.get(k);
        if (!cur){ added.push(inc); continue; }
        let has=false; const fields={};
        for (const [key,label] of FIELDS){
          const a=normVal(cur[key]), b=normVal(inc[key]);
          const diff = a!==b;
          if (diff) has=true;
          fields[key] = { label, current:a, incoming:b, changed:diff };
        }
        if (has) updated.push({key:k, name:inc.name, fields, _cur:cur, _inc:inc});
      }
      for (const [k, cur] of curMap.entries()){
        if (!incMap.has(k)) removed.push(cur);
      }
      return { added, removed, updated };
    }

    function showVerifyDiffModal(currentRows, incomingRows, onApply, onCancel){
      const modal = $("verifyModal");
      const sumEl = $("verifySummary");
      const body = $("verifyBody");
      const { added, removed, updated } = diffDatasets(currentRows, incomingRows);

      const selAdd = new Map(added.map(r => [rowKey(r), true]));
      const selRem = new Map(removed.map(r => [rowKey(r), false]));
      const selUpd = new Map(updated.map(u => [u.key, Object.fromEntries(Object.entries(u.fields).map(([k,f])=>[k, !!f.changed]))]));

      sumEl.innerHTML = `
        <div class="flex flex-wrap gap-3 text-sm">
          <span class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-700">Th√™m m·ªõi: ${added.length}</span>
          <span class="px-3 py-1 rounded-full bg-amber-50 text-amber-700">Thay ƒë·ªïi: ${updated.length}</span>
          <span class="px-3 py-1 rounded-full bg-rose-50 text-rose-700">Xo√°: ${removed.length}</span>
        </div>`;

      const section = (title, content, extra="") => `
        <div class="rounded-xl border border-slate-200 overflow-hidden">
          <div class="px-4 py-2 bg-slate-50 flex items-center justify-between">
            <div class="font-semibold">${title}</div>
            ${extra}
          </div>
          <div class="p-4">${content}</div>
        </div>`;

      const renderAdded = () => added.length
        ? added.map(r=>`
          <label class="flex items-center gap-3 py-2 border-b last:border-0">
            <input type="checkbox" class="addRow accent-indigo-600" data-k="${rowKey(r)}" checked />
            <div><div class="font-medium">${r.name}</div><div class="text-xs text-slate-500">${r.role||""} ‚Ä¢ ${r.unit||""}</div></div>
          </label>`).join("")
        : `<div class="text-slate-500 text-sm">Kh√¥ng c√≥ b·∫£n ghi m·ªõi.</div>`;

      const renderRemoved = () => removed.length
        ? removed.map(r=>`
          <label class="flex items-center gap-3 py-2 border-b last:border-0">
            <input type="checkbox" class="remRow accent-rose-600" data-k="${rowKey(r)}" />
            <div><div class="font-medium">${r.name}</div><div class="text-xs text-slate-500">${r.role||""} ‚Ä¢ ${r.unit||""}</div></div>
          </label>`).join("")
        : `<div class="text-slate-500 text-sm">Kh√¥ng c√≥ b·∫£n ghi c·∫ßn xo√°.</div>`;

      const renderUpdated = () => updated.length
        ? updated.map(u=>{
            const rows = Object.entries(u.fields).map(([key,f])=>{
              const checked = selUpd.get(u.key)?.[key];
              const hl = f.changed ? "diff-cell" : "";
              return `
              <tr class="border-b last:border-0">
                <td class="px-2 py-1 text-xs text-slate-500">${f.label}</td>
                <td class="px-2 py-1">${f.current ?? ""}</td>
                <td class="px-2 py-1 ${hl}">${f.incoming ?? ""}</td>
                <td class="px-2 py-1 text-center">
                  <input type="checkbox" class="updCell accent-emerald-600" data-k="${u.key}" data-field="${key}" ${checked?'checked':''}/>
                </td>
              </tr>`;
            }).join("");
            return `
              <details class="rounded-lg border border-slate-200 mb-3" open>
                <summary class="px-3 py-2 cursor-pointer bg-slate-50 flex items-center justify-between">
                  <div><span class="font-semibold">${u.name}</span>
                  <span class="text-xs text-slate-500"> ‚Ä¢ ${u._inc.role||""} ‚Ä¢ ${u._inc.unit||""}</span></div>
                  <div class="text-xs text-slate-500">Tick √¥ mu·ªën c·∫≠p nh·∫≠t</div>
                </summary>
                <div class="p-2 overflow-auto">
                  <table class="min-w-full text-sm">
                    <thead class="bg-slate-100"><tr>
                      <th class="px-2 py-1 text-left text-xs">Tr∆∞·ªùng</th>
                      <th class="px-2 py-1 text-left text-xs">Hi·ªán t·∫°i</th>
                      <th class="px-2 py-1 text-left text-xs">Theo file</th>
                      <th class="px-2 py-1 text-left text-xs">C·∫≠p nh·∫≠t</th>
                    </tr></thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
              </details>`;
          }).join("")
        : `<div class="text-slate-500 text-sm">Kh√¥ng c√≥ b·∫£n ghi thay ƒë·ªïi.</div>`;

      body.innerHTML = `
        ${section("üÜï B·∫£n ghi m·ªõi", renderAdded(),
          added.length?'<button id="toggleAddAll" class="text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300">Ch·ªçn/B·ªè t·∫•t c·∫£</button>':'')}
        ${section("‚úèÔ∏è B·∫£n ghi thay ƒë·ªïi", renderUpdated())}
        ${section("üóëÔ∏è B·∫£n ghi c√≥ th·ªÉ xo√° (t√πy ch·ªçn)", renderRemoved(),
          removed.length?'<button id="toggleRemAll" class="text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300">Ch·ªçn/B·ªè t·∫•t c·∫£</button>':'')}
      `;

      body.addEventListener("change", (e)=>{
        const t=e.target;
        if (t.classList.contains("addRow")) selAdd.set(t.dataset.k, t.checked);
        if (t.classList.contains("remRow")) selRem.set(t.dataset.k, t.checked);
        if (t.classList.contains("updCell")){
          const k=t.dataset.k, f=t.dataset.field;
          const row = selUpd.get(k)||{}; row[f]=t.checked; selUpd.set(k,row);
        }
      });
      on($("toggleAddAll"),"click",()=>{
        const all=[...body.querySelectorAll(".addRow")];
        const needCheck = all.some(i=>!i.checked);
        all.forEach(i=>{i.checked=needCheck; selAdd.set(i.dataset.k, needCheck);});
      });
      on($("toggleRemAll"),"click",()=>{
        const all=[...body.querySelectorAll(".remRow")];
        const needCheck = all.some(i=>!i.checked);
        all.forEach(i=>{i.checked=needCheck; selRem.set(i.dataset.k, needCheck);});
      });

      $("verifyModal").classList.remove("hidden");
      $("verifyModal").classList.add("flex");

      const close = ()=>{$("verifyModal").classList.add("hidden");};
      on($("closeVerifyBtn"),"click",()=>{close(); onCancel&&onCancel();});
      on($("cancelImportBtn"),"click",()=>{close(); onCancel&&onCancel();});
      on($("confirmImportBtn"),"click",()=>{
        const curMap = new Map(currentRows.map(r=>[rowKey(r), {...r}]));
        for (const u of updated){
          const k=u.key; const cur=curMap.get(k)||{};
          const choose = selUpd.get(k)||{};
          for (const [field] of Object.entries(u.fields)){
            if (choose[field]) cur[field] = u._inc[field] ?? null;
          }
          curMap.set(k,cur);
        }
        for (const r of added){ if (selAdd.get(rowKey(r))) curMap.set(rowKey(r), {...r}); }
        for (const r of removed){ const k=rowKey(r); if (selRem.get(k)) curMap.delete(k); }
        close(); onApply && onApply(Array.from(curMap.values()));
      });
    }

    // ===== State + Render =====
    const STORE_KEY="qlLuongDatasetV1";
    const saveCache = rows => { try{localStorage.setItem(STORE_KEY, JSON.stringify(rows));}catch{} };
    const loadCache = () => { try{return JSON.parse(localStorage.getItem(STORE_KEY)||"[]");}catch{return[];} };

    function uniqueVals(rows, key){
      return [...new Set(rows.map(r=>(r[key]||"").trim()).filter(Boolean))]
        .sort((a,b)=>a.localeCompare(b,"vi",{sensitivity:"base"}));
    }
    function populateFilters(rows){
      const roles=uniqueVals(rows,"role"), levels=uniqueVals(rows,"level"), ranks=uniqueVals(rows,"rank");
      const fill=(sel, arr, label)=>{
        if (!sel) return;
        const cur=sel.value;
        sel.innerHTML = `<option value="">‚Äî T·∫•t c·∫£ ${label} ‚Äî</option>` + arr.map(v=>`<option>${v}</option>`).join("");
        if (arr.includes(cur)) sel.value=cur; else sel.value="";
      };
      fill($("filterRole"), roles, "ch·ª©c danh");
      fill($("filterLevel"), levels, "c·∫•p h·ªçc");
      fill($("filterRank"), ranks, "h·∫°ng");
    }

    function renderKpis(rows){
      const total = rows.length;
      const countBy = (fn)=>rows.reduce((m,r)=>{const k=fn(r); m[k]=(m[k]||0)+1; return m;},{});
      const roles = countBy(r=>(r.role||"").toLowerCase());
      const sum = k=> (roles[k]||0);
      const html = [
        ["T·ªïng b·∫£n ghi", total, "bg-indigo-50 text-indigo-700"],
        ["Gi√°o vi√™n", sum("gi√°o vi√™n")+sum("giao vien"), "bg-emerald-50 text-emerald-700"],
        ["Hi·ªáu tr∆∞·ªüng", sum("hi·ªáu tr∆∞·ªüng")+sum("hieu truong"), "bg-rose-50 text-rose-700"],
        ["Ph√≥ Hi·ªáu tr∆∞·ªüng", sum("ph√≥ hi·ªáu tr∆∞·ªüng")+sum("pho hieu truong"), "bg-amber-50 text-amber-700"]
      ].map(([label,val,cls])=>`
        <div class="p-4 rounded-xl border ${cls} border-slate-100">
          <div class="text-sm opacity-70">${label}</div>
          <div class="text-2xl font-bold mt-1">${val}</div>
        </div>`).join("");
      $("excelKpis").innerHTML = html;
      const byRank = rows.reduce((m,r)=>{const k=r.rank||"Kh√°c"; m[k]=(m[k]||0)+1; return m;}, {});
      $("rankChips").innerHTML = Object.entries(byRank).sort((a,b)=>b[1]-a[1]).slice(0,8)
        .map(([k,v])=>`<span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-xs">${k}: ${v}</span>`).join("");
    }

    function renderTable(rows){
      const root=$("tableRoot"); if(!root) return;
      const headers = [
        ["name","H·ªç v√† t√™n"], ["role","Ch·ª©c danh"], ["unit","ƒê∆°n v·ªã"],
        ["level","C·∫•p h·ªçc"], ["rank","H·∫°ng"], ["rankCode","M√£ CDNN"],
        ["coefficient","H·ªá s·ªë"], ["effectiveDate","Ng√†y h∆∞·ªüng"], ["note","Ghi ch√∫"]
      ];
      const thead = `
        <thead class="bg-slate-50 sticky top-0">
          <tr>
          ${headers.map(([k,l])=>`<th data-sort="${k}" class="px-3 py-2 text-left text-sm font-semibold text-slate-700 cursor-pointer">${l}</th>`).join("")}
          </tr>
        </thead>`;
      const body = rows.map(r=>`
        <tr class="border-b hover:bg-slate-50">
          <td class="px-3 py-2">${escapeHtml(r.name)}</td>
          <td class="px-3 py-2">${escapeHtml(r.role)}</td>
          <td class="px-3 py-2">${escapeHtml(r.unit)}</td>
          <td class="px-3 py-2">${escapeHtml(r.level)}</td>
          <td class="px-3 py-2">${escapeHtml(r.rank)}</td>
          <td class="px-3 py-2">${escapeHtml(r.rankCode)}</td>
          <td class="px-3 py-2">${r.coefficient ?? ""}</td>
          <td class="px-3 py-2">${r.effectiveDate ? new Date(r.effectiveDate).toLocaleDateString("vi-VN") : ""}</td>
          <td class="px-3 py-2">${escapeHtml(r.note)}</td>
        </tr>`).join("");
      root.innerHTML = `<table class="min-w-full text-sm">${thead}<tbody>${body||`<tr><td colspan="9" class="px-3 py-6 text-slate-500">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`}</tbody></table>`;
      root.querySelectorAll("[data-sort]").forEach(th=>{
        th.addEventListener("click", ()=>{
          const key=th.dataset.sort;
          if (sort.key===key) sort.dir*=-1; else {sort.key=key; sort.dir=1;}
          refresh();
        });
      });
    }
    const escapeHtml = s => (s==null?"":String(s)).replace(/[<>&]/g,c=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[c]));
    function applySearch(rows, q){
      const s = slug(q||""); if (!s) return [...rows];
      return rows.filter(r=>{
        const hay=[r.name,r.role,r.unit,r.level,r.rank,r.rankCode,r.coefficient,r.note].map(x=>slug(String(x??""))).join(" ");
        return hay.includes(s);
      });
    }
    function applyFilters(rows){
      return rows.filter(r=>
        (!filters.role  || r.role  === filters.role) &&
        (!filters.level || r.level === filters.level) &&
        (!filters.rank  || r.rank  === filters.rank)
      );
    }
    function applySort(rows){
      const {key,dir}=sort;
      if (!key) return [...rows];
      const a=[...rows];
      a.sort((x,y)=>{
        const va=x?.[key], vb=y?.[key];
        if (va==null && vb==null) return 0;
        if (va==null) return 1; if (vb==null) return -1;
        if (va instanceof Date || vb instanceof Date) return dir*((va?.getTime?.()||0)-(vb?.getTime?.()||0));
        if (typeof va==="number" || typeof vb==="number") return dir*((Number(va)||0)-(Number(vb)||0));
        return dir*String(va).localeCompare(String(vb),"vi",{sensitivity:"base"});
      });
      return a;
    }

    // ===== App state & events =====
    let fullRecords = loadCache();
    let sort = { key:null, dir:1 };
    let filters = { role:"", level:"", rank:"" };

    function populateAndRefresh(){
      populateFilters(fullRecords);
      refresh();
    }
    function refresh(){
      const q=$("searchInput")?.value||"";
      let rows=[...fullRecords];
      rows=applyFilters(rows);
      rows=applySearch(rows,q);
      rows=applySort(rows);
      renderKpis(rows);
      renderTable(rows);
    }

    on($("uploadExcelBtn"), "click", async ()=>{
      const file = $("excelFileInput")?.files?.[0];
      if (!file){ alert("Vui l√≤ng ch·ªçn file Excel!"); return; }
      try{
        const parsed = await parseExcelFile(file);
        if (!parsed.length){ alert("‚ö†Ô∏è Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c b·∫£n ghi n√†o t·ª´ file. Ki·ªÉm tra ti√™u ƒë·ªÅ/sheet ho·∫∑c g·ª≠i ·∫£nh header ƒë·ªÉ m√¨nh b·ªï sung mapping."); return; }
        showVerifyDiffModal(fullRecords, parsed, (merged)=>{
          fullRecords = merged;
          saveCache(fullRecords);
          sort = { key:null, dir:1 };
          filters = { role:"", level:"", rank:"" };
          $("searchInput").value="";
          populateAndRefresh();
          alert(`‚úÖ ƒê√£ √°p d·ª•ng thay ƒë·ªïi. T·ªïng b·∫£n ghi: ${fullRecords.length}`);
        }, ()=>{});
      }catch(err){
        console.error(err);
        alert("L·ªói import: " + (err?.message||err));
      }
    });

    on($("exportExcelBtn"), "click", ()=>{
      if (!fullRecords?.length) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t."); return; }
      if (typeof XLSX === "undefined"){ alert("Thi·∫øu th∆∞ vi·ªán XLSX."); return; }
      const data = fullRecords.map(r=>({
        "H·ªç v√† t√™n": r.name || "",
        "Ch·ª©c danh": r.role || "",
        "ƒê∆°n v·ªã": r.unit || "",
        "C·∫•p h·ªçc": r.level || "",
        "H·∫°ng": r.rank || "",
        "M√£ CDNN": r.rankCode || "",
        "H·ªá s·ªë": r.coefficient ?? "",
        "Ng√†y h∆∞·ªüng": r.effectiveDate ? new Date(r.effectiveDate).toISOString().slice(0,10) : "",
        "Ghi ch√∫": r.note || ""
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Du lieu");
      XLSX.writeFile(wb, `DuLieu_${new Date().toISOString().slice(0,10)}.xlsx`);
    });

    on($("searchInput"), "input", refresh);
    on($("filterRole"), "change", e=>{filters.role=e.target.value||""; refresh();});
    on($("filterLevel"),"change", e=>{filters.level=e.target.value||""; refresh();});
    on($("filterRank"), "change", e=>{filters.rank=e.target.value||""; refresh();});

    // Init
    window.addEventListener("DOMContentLoaded", ()=>{
      populateAndRefresh();
      if (typeof XLSX === "undefined") console.error("‚ùå XLSX ch∆∞a t·∫£i. Ki·ªÉm tra CDN trong <head>.");
    });

    window.addEventListener("error", e=>console.error("JS error:", e?.error?.message || e.message || e));
  })();
  </script>
</body>
</html>

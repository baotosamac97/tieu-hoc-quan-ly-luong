jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Verify firebase.json exists
        run: |
          ls -la
          test -f firebase.json || (echo "❌ Missing firebase.json at repo root" && exit 1)
          cat firebase.json

      - name: Write service account to file
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_LUONG }}' > "${RUNNER_TEMP}/sa.json"
          node -e "JSON.parse(require('fs').readFileSync(process.env.RUNNER_TEMP+'/sa.json','utf8')); console.log('✅ SA JSON OK')"

      - name: Install Firebase CLI
        run: npm i -g firebase-tools

      - name: Deploy with debug
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/sa.json
        run: firebase deploy --only hosting --project tieu-hoc-quan-ly-luong --non-interactive --debug
